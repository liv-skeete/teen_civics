{% extends "base.html" %}
{# Updated poll results design - 2025-10-03 #}

{% block title %}Bill Archive - TeenCivics{% endblock %}

{% block content %}
<div class="container">
    <div class="resources-header">
        <h1 class="h3-style">Bill Archive</h1>
        <p>Browse all congressional bills summarized by TeenCivics</p>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-and-filter-section">
        <form class="search-form" method="get" action="{{ url_for('archive') }}" id="archive-form">
            <!-- Top Row: Search Input and Buttons -->
            <div class="search-row">
                <input
                    type="search"
                    class="search-input"
                    name="q"
                    value="{{ q or '' }}"
                    placeholder="Search by bill ID, title, sponsor, or keywords"
                    aria-label="Search bills"
                    autocomplete="off"
                    enterkeyhint="search"
                >
                <button 
                    type="submit" 
                    class="btn btn-search"
                    aria-label="Search bills"
                >
                    Search
                </button>
                {% if q %}
                <a 
                    href="{{ url_for('archive') }}" 
                    class="btn btn-clear"
                    aria-label="Clear search"
                >
                    Clear
                </a>
                {% endif %}
            </div>

            <!-- Bottom Row: Filters and Sort -->
            <div class="controls-row">
                <!-- Status Filter -->
                <div class="filter-form">
                    <label for="status-filter">Filter by status:</label>
                    <select name="status" id="status-filter" aria-label="Filter bills by status">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                        <option value="agreed_to_in_house" {% if status_filter == 'agreed_to_in_house' %}selected{% endif %}>Agreed to in House</option>
                        <option value="agreed_to_in_senate" {% if status_filter == 'agreed_to_in_senate' %}selected{% endif %}>Agreed to in Senate</option>
                        <option value="became_law" {% if status_filter == 'became_law' %}selected{% endif %}>Became Law</option>
                        <option value="committee_consideration" {% if status_filter == 'committee_consideration' %}selected{% endif %}>Committee Consideration</option>
                        <option value="failed_house" {% if status_filter == 'failed_house' %}selected{% endif %}>Failed House</option>
                        <option value="failed_senate" {% if status_filter == 'failed_senate' %}selected{% endif %}>Failed Senate</option>
                        <option value="introduced" {% if status_filter == 'introduced' %}selected{% endif %}>Introduced</option>
                        <option value="passed_house" {% if status_filter == 'passed_house' %}selected{% endif %}>Passed House</option>
                        <option value="passed_senate" {% if status_filter == 'passed_senate' %}selected{% endif %}>Passed Senate</option>
                        <option value="referred_to_committee" {% if status_filter == 'referred_to_committee' %}selected{% endif %}>Referred to Committee</option>
                        <option value="reported_by_committee" {% if status_filter == 'reported_by_committee' %}selected{% endif %}>Reported by Committee</option>
                        <option value="vetoed" {% if status_filter == 'vetoed' %}selected{% endif %}>Vetoed</option>
                    </select>
                </div>

                <!-- Sort by Teen Impact -->
                <div class="sort-control">
                    <label for="sort-by-impact">
                        <input 
                            type="checkbox" 
                            id="sort-by-impact" 
                            name="sort_by_impact" 
                            value="1" 
                            {% if sort_by_impact %}checked{% endif %}
                            aria-label="Sort bills by teen impact score"
                        >
                        <span>Sort by Teen Impact Score</span>
                    </label>
                </div>
            </div>

            <!-- Hidden field to preserve pagination state -->
            <input type="hidden" name="page" value="{{ current_page }}" id="page-input">
        </form>
    </div>

    {% if error or error_message %}
    <div class="error-message">
        <p>{{ error or error_message }}</p>
    </div>
    {% endif %}

    {% if bills %}
    <div class="results-summary">
        {% if total_results > 0 %}
            Showing {{ ((current_page - 1) * page_size) + 1 }}‚Äì{{ ((current_page - 1) * page_size) + bills|length }} of {{ total_results }} result{{ 's' if total_results != 1 else '' }}{% if q %} for "<strong>{{ q }}</strong>"{% endif %}{% if status_filter != 'all' %} with status "<strong>{{ status_filter|format_status }}</strong>"{% endif %}{% if sort_by_impact %} <strong>sorted by Teen Impact Score</strong>{% endif %}.
        {% endif %}
    </div>
    <div class="bills-grid">
        {% for bill in bills %}
        <article class="bill-card" data-status="{{ bill.normalized_status }}" data-teen-impact="{{ bill.teen_impact_score if bill.teen_impact_score is not none else '' }}" data-original-index="{{ loop.index0 }}">
            <div class="bill-header">
                <h2 class="bill-title h3-style">
                    <a href="{{ url_for('bill_detail', slug=bill.website_slug) }}">{{ bill.short_title or (bill.title|shorten_title(80)) }}</a>
                </h2>
                
                <!-- Bill metadata -->
                <div class="bill-meta">
                    <span class="bill-id">{{ bill.bill_id }}</span>
                    <span class="bill-date">{{ bill.date_introduced|format_date }}</span>
                    <span class="bill-status {{ (bill.normalized_status or '')|lower|replace('_', '-')|replace(' ', '-') }}">{{ bill.normalized_status|format_status }}</span>
                    {% if bill.teen_impact_score is not none %}
                    <span class="teen-impact-badge">Teen Impact: {{ bill.teen_impact_score }}/10</span>
                    {% endif %}
                </div>
            </div>

            <div class="bill-content">
                <div class="summary-preview">
                    {{ bill.summary_tweet|truncate(200) }}
                </div>
                
                <br>
                
                <div class="bill-actions">
                    <a href="{{ url_for('bill_detail', slug=bill.website_slug) }}" class="btn btn-primary btn-small">
                        Read Summary
                    </a>
                    <div class="share-dropdown">
                        <button class="btn btn-share btn-small" aria-expanded="false" aria-haspopup="true">
                            Share This Bill
                        </button>
                        <div class="share-options" role="menu" aria-label="Share options">
                            <a href="https://twitter.com/intent/tweet?text={{ ('Check out this bill on @TeenCivics: ' ~ bill.title ~ '\n\n' ~ url_for('bill_detail', slug=bill.website_slug, _external=True))|urlencode }}"
                               target="_blank" rel="noopener" class="share-option share-x" role="menuitem">
                                ùïè Share on X
                            </a>
                            <a href="https://bsky.app/intent/compose?text={{ ('Check out this bill on @teencivics.bsky.social: ' ~ bill.title ~ '\n\n' ~ url_for('bill_detail', slug=bill.website_slug, _external=True))|urlencode }}"
                               target="_blank" rel="noopener" class="share-option share-bluesky" role="menuitem">
                                ü¶ã Share on Bluesky
                            </a>
                            <a href="https://www.threads.net/intent/post?text={{ ('Check out this bill on @teen.civics: ' ~ bill.title ~ '\n\n' ~ url_for('bill_detail', slug=bill.website_slug, _external=True))|urlencode }}"
                               target="_blank" rel="noopener" class="share-option share-threads" role="menuitem">
                                üßµ Share on Threads
                            </a>
                            <button class="share-option share-copy" role="menuitem" data-url="{{ url_for('bill_detail', slug=bill.website_slug, _external=True) }}">
                                üîó Copy Link
                            </button>
                        </div>
                    </div>
                </div>

                {% if bill.poll_results_yes is defined or bill.poll_results_no is defined %}
                <div class="poll-preview">
                    <h4>Community Poll</h4>
                    {% set total_votes = (bill.poll_results_yes or 0) + (bill.poll_results_no or 0) %}
                    {% if total_votes > 0 %}
                        {% set yes_percentage = ((bill.poll_results_yes or 0) / total_votes * 100)|round(1) %}
                        {% set no_percentage = ((bill.poll_results_no or 0) / total_votes * 100)|round(1) %}
                        <div class="poll-results" style="--yes-width: {{ yes_percentage }}%; --no-width: {{ no_percentage }}%;">
                            <div class="poll-option">
                                <span class="poll-label">Yes</span>
                                <div class="poll-bar">
                                    <div class="poll-fill yes-fill"></div>
                                </div>
                                <span class="poll-percentage">{{ yes_percentage }}%</span>
                            </div>
                            <div class="poll-option">
                                <span class="poll-label">No</span>
                                <div class="poll-bar">
                                    <div class="poll-fill no-fill"></div>
                                </div>
                                <span class="poll-percentage">{{ no_percentage }}%</span>
                            </div>
                            <p class="poll-total">{{ total_votes }} total vote{{ 's' if total_votes != 1 else '' }}</p>
                        </div>
                    {% else %}
                        <p class="no-votes">No votes yet</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if current_page > 1 %}
        <a href="{{ url_for('archive', page=current_page - 1, q=q, status=status_filter if status_filter != 'all' else None, sort_by_impact=1 if sort_by_impact else None) }}" class="page-link prev" aria-label="Go to previous page">
            ‚Üê Previous
        </a>
        {% endif %}

        {% for page_num in range(1, total_pages + 1) %}
            {% if page_num == current_page %}
            <span class="page-link current" aria-current="page">{{ page_num }}</span>
            {% else %}
            <a href="{{ url_for('archive', page=page_num, q=q, status=status_filter if status_filter != 'all' else None, sort_by_impact=1 if sort_by_impact else None) }}" class="page-link" aria-label="Go to page {{ page_num }}">
                {{ page_num }}
            </a>
            {% endif %}
        {% endfor %}

        {% if current_page < total_pages %}
        <a href="{{ url_for('archive', page=current_page + 1, q=q, status=status_filter if status_filter != 'all' else None, sort_by_impact=1 if sort_by_impact else None) }}" class="page-link next" aria-label="Go to next page">
            Next ‚Üí
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="no-bills-message">
        <h2>No Results Found</h2>
        {% if q %}
            <p>No bills found for your search query "<strong>{{ q }}</strong>"{% if status_filter != 'all' %} with status "<strong>{{ status_filter|format_status }}</strong>"{% endif %}.</p>
            <a href="{{ url_for('archive') }}" class="btn btn-primary">Clear Search</a>
        {% elif status_filter != 'all' %}
            <p>No bills found with status "<strong>{{ status_filter|format_status }}</strong>".</p>
            <a href="{{ url_for('archive') }}" class="btn btn-primary">View All Bills</a>
        {% else %}
            <p>No bills available in the archive yet.</p>
        {% endif %}
    </div>
    {% endif %}
    
    <script>
    // Improved form submission handling with visual feedback
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('archive-form');
        const statusFilter = document.getElementById('status-filter');
        const sortCheckbox = document.getElementById('sort-by-impact');
        const pageInput = document.getElementById('page-input');
        
        // Prevent double submission
        let isSubmitting = false;
        
        function submitForm() {
            if (isSubmitting) return;
            isSubmitting = true;
            
            // Reset to page 1 when changing filters or sort
            pageInput.value = '1';
            
            // Add loading state for visual feedback
            form.classList.add('loading');
            
            // Submit after brief delay to ensure checkbox visual update
            setTimeout(() => {
                form.submit();
            }, 100);
        }
        
        // Status filter change handler
        if (statusFilter) {
            statusFilter.addEventListener('change', submitForm);
        }
        
        // Sort checkbox change handler
        if (sortCheckbox) {
            sortCheckbox.addEventListener('change', submitForm);
        }
        
        // Reset submission flag on page show (handles browser back button)
        window.addEventListener('pageshow', function() {
            isSubmitting = false;
            form.classList.remove('loading');
        });
    });
    </script>
{% endblock %}